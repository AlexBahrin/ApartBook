{% extends 'staff/base_staff.html' %}
{% load i18n %}

{% block title %}{% trans "Manage Images" %} - {{ apartment.title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    .image-item {
        position: relative;
        cursor: move;
        border: 2px solid transparent;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .image-item:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .image-item.dragging {
        opacity: 0.5;
    }
    .image-item.drag-over {
        border-color: var(--bs-success);
        border-style: dashed;
    }
    .image-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 6px;
    }
    .main-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
    .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: var(--bs-primary);
        background-color: rgba(13, 110, 253, 0.05);
    }
</style>
{% endblock %}

{% block staff_content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'staff_apartments' %}">{% trans "Apartments" %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'staff_apartment_edit' apartment.pk %}">{{ apartment.title }}</a></li>
        <li class="breadcrumb-item active">{% trans "Images" %}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-12">
        <!-- Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Upload Images" %}</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    <div class="upload-zone" id="uploadZone">
                        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                        <p class="mt-3 mb-2"><strong>{% trans "Drop images here or click to browse" %}</strong></p>
                        <p class="text-muted small">{% trans "You can upload multiple images at once" %}</p>
                        <input type="file" name="images" id="imageInput" multiple accept="image/*" style="display: none;">
                    </div>
                    <div id="preview" class="mt-3"></div>
                </form>
            </div>
        </div>

        <!-- Images Grid -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "Current Images" %}</h5>
                <small class="text-muted">{% trans "Drag to reorder - First image is the main photo" %}</small>
            </div>
            <div class="card-body">
                {% if images %}
                    <div class="image-grid" id="imageGrid">
                        {% for image in images %}
                            <div class="image-item" draggable="true" data-id="{{ image.pk }}">
                                {% if forloop.first %}
                                    <span class="badge bg-primary main-badge">{% trans "Main Photo" %}</span>
                                {% endif %}
                                <form method="post" action="{% url 'staff_delete_image' image.pk %}" class="delete-btn" onsubmit="return confirm('{% trans "Delete this image?" %}');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                <img src="{{ image.image.url }}" alt="{{ apartment.title }}">
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        <p class="text-muted mt-3">{% trans "No images uploaded yet" %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageInput');
    const uploadForm = document.getElementById('uploadForm');
    const preview = document.getElementById('preview');
    const imageGrid = document.getElementById('imageGrid');
    
    console.log('Elements loaded:', {
        uploadZone: !!uploadZone,
        imageInput: !!imageInput,
        uploadForm: !!uploadForm,
        preview: !!preview,
        imageGrid: !!imageGrid
    });
    
    // Upload zone click handler
    uploadZone.addEventListener('click', () => {
        console.log('Upload zone clicked');
        imageInput.value = ''; // Reset to allow re-selecting same files
        imageInput.click();
    });
    
    // File input change
    imageInput.addEventListener('change', function(e) {
        console.log('File input changed, files:', e.target.files.length);
        if (e.target.files.length > 0) {
            handleFiles(e.target.files);
        }
    });
    
    // Drag and drop upload
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        // Only show drag-over for actual file drops, not image reordering
        if (e.dataTransfer.types.includes('Files')) {
            uploadZone.classList.add('drag-over');
        }
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        // Only handle actual file drops, not image reordering
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }
    });
    
    function handleFiles(files) {
        if (files.length === 0) return;
        
        console.log('Uploading', files.length, 'file(s)');
        
        // Create FormData and upload
        const formData = new FormData();
        for (let file of files) {
            formData.append('images', file);
            console.log('Added file:', file.name);
        }
        
        // Show uploading message
        preview.innerHTML = '<div class="alert alert-info"><i class="bi bi-upload"></i> Uploading ' + files.length + ' image(s)...</div>';
        
        // Upload via AJAX
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                window.location.reload();
            } else {
                preview.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Upload failed') + '</div>';
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            preview.innerHTML = '<div class="alert alert-danger">Error uploading images: ' + error.message + '</div>';
        });
    }
    
    // Drag and drop reordering
    if (imageGrid) {
        let draggedItem = null;
        
        const items = imageGrid.querySelectorAll('.image-item');
        items.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            });
            
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedItem = null;
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (draggedItem && draggedItem !== this) {
                    this.classList.add('drag-over');
                    e.dataTransfer.dropEffect = 'move';
                }
            });
            
            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                if (draggedItem && draggedItem !== this) {
                    // Get all items
                    const allItems = Array.from(imageGrid.querySelectorAll('.image-item'));
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const targetIndex = allItems.indexOf(this);
                    
                    // Reorder in DOM
                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this);
                    }
                    
                    // Update main badge
                    updateMainBadge();
                    
                    // Save new order
                    saveOrder();
                }
            });
        });
    }
    
    function updateMainBadge() {
        // Remove all main badges
        document.querySelectorAll('.main-badge').forEach(badge => badge.remove());
        
        // Add main badge to first item
        const firstItem = imageGrid.querySelector('.image-item');
        if (firstItem) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary main-badge';
            badge.textContent = '{% trans "Main Photo" %}';
            firstItem.insertBefore(badge, firstItem.firstChild);
        }
    }
    
    function saveOrder() {
        const items = imageGrid.querySelectorAll('.image-item');
        const order = Array.from(items).map(item => item.dataset.id);
        
        fetch('{% url "staff_reorder_images" apartment.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ order: order })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Order saved successfully');
            }
        })
        .catch(error => {
            console.error('Error saving order:', error);
        });
    }
});
</script>
{% endblock %}
